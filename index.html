<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ahaar Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }

        #headerContent {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 42px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        #modeToggle {
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        #modeToggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        #modeToggle.seek {
            background: #3b82f6;
            color: white;
        }

        #modeToggle.donate {
            background: #f59e0b;
            color: white;
        }

        #mainContent {
            display: flex;
            height: calc(100vh - 100px);
        }

        #map {
            flex: 1;
            height: 100%;
        }

        #sidebar {
            width: 400px;
            background: white;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        #addButton {
            margin: 20px;
            padding: 16px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        #addButton:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        #addForm {
            margin: 0 20px 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        #addForm input, #addForm textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        #addForm input:focus, #addForm textarea:focus {
            outline: none;
            border-color: #10b981;
        }

        #addForm textarea {
            resize: vertical;
            min-height: 80px;
        }

        .formButtons {
            display: flex;
            gap: 10px;
        }

        .formButtons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .formButtons button:first-child {
            background: #10b981;
            color: white;
        }

        .formButtons button:first-child:hover {
            background: #059669;
        }

        .formButtons button:first-child:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .formButtons button:last-child {
            background: #e5e7eb;
            color: #374151;
        }

        .formButtons button:last-child:hover {
            background: #d1d5db;
        }

        #listings {
            padding: 0 20px 20px;
            flex: 1;
        }

        .listing {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .listing:hover {
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            transform: translateY(-2px);
        }

        .listing h3 {
            color: #111827;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .listing-info {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .listing-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #9ca3af;
        }

        .directionsBtn {
            margin-top: 10px;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .directionsBtn:hover {
            background: #2563eb;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
        }

        .leaflet-popup-content {
            margin: 12px;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="headerContent">
            <h1>üçΩÔ∏è Ahaar Hub</h1>
            <button id="modeToggle" class="seek">üîç Seeking Food</button>
        </div>
    </div>

    <div id="mainContent">
        <div id="map"></div>
        <div id="sidebar">
            <button id="addButton" class="hidden">+ Add Food Donation</button>
            <div id="addForm" class="hidden">
                <h3 style="margin-bottom: 12px; color: #111827; font-size: 18px;">Share Excess Food</h3>
                <div id="formError" class="error-message hidden"></div>
                <input type="text" id="foodInput" placeholder="What food is available?">
                <input type="text" id="locationInput" placeholder="Location/Address">
                <textarea id="detailsInput" placeholder="Additional details (optional)"></textarea>
                <div class="formButtons">
                    <button id="postBtn">Post</button>
                    <button id="cancelBtn">Cancel</button>
                </div>
            </div>
            <div id="listings"></div>
        </div>
    </div>

    <script>
        let map;
        let userMarker;
        let userLocation = [28.6139, 77.2090]; // Default to New Delhi
        let markers = [];
        let mode = 'seek';
        let routingControl = null;

        // Sample food listings
        let foodListings = [
            {
                id: 1,
                food: 'Pizza slices (6)',
                location: 'India Gate, New Delhi',
                lat: 28.6129,
                lng: 77.2295,
                time: '20 mins ago',
                donor: 'Local Pizza Place',
                details: 'Still hot and fresh'
            },
            {
                id: 2,
                food: 'Fresh vegetables & fruits',
                location: 'Connaught Place, New Delhi',
                lat: 28.6315,
                lng: 77.2167,
                time: '1 hour ago',
                donor: 'Weekly Market',
                details: 'Perfectly good for consumption'
            },
            {
                id: 3,
                food: 'Cooked rice and dal (10 servings)',
                location: 'Chandni Chowk, Old Delhi',
                lat: 28.6506,
                lng: 77.2303,
                time: '45 mins ago',
                donor: 'Community Kitchen',
                details: 'Hygienically prepared'
            },
            {
                id: 4,
                food: 'Bread loaves (5)',
                location: 'Karol Bagh, New Delhi',
                lat: 28.6519,
                lng: 77.1909,
                time: '30 mins ago',
                donor: 'Bakery',
                details: 'Best before today evening'
            }
        ];

        function initMap() {
            // Initialize map
            map = L.map('map').setView(userLocation, 12);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Try to get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(userLocation, 13);
                        updateUserMarker();
                    },
                    () => {
                        updateUserMarker();
                    }
                );
            } else {
                updateUserMarker();
            }

            renderMarkers();
            renderListings();
        }

        function updateUserMarker() {
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            const userIcon = L.divIcon({
                className: 'custom-div-icon',
                html: '<div style="background: #3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });
            
            userMarker = L.marker(userLocation, { icon: userIcon })
                .addTo(map)
                .bindPopup('üìç Your Location');
        }

        function renderMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add food markers
            foodListings.forEach(listing => {
                const foodIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: '<div style="background: #10b981; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([listing.lat, listing.lng], { icon: foodIcon })
                    .addTo(map)
                    .bindPopup(`
                        <div style="min-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; color: #111827; font-size: 16px;">${listing.food}</h3>
                            <p style="margin: 0 0 5px 0; color: #6b7280; font-size: 13px;">üìç ${listing.location}</p>
                            ${listing.details ? `<p style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px;">${listing.details}</p>` : ''}
                            <p style="margin: 0; color: #9ca3af; font-size: 12px;">‚è∞ ${listing.time} ‚Ä¢ üë§ ${listing.donor}</p>
                        </div>
                    `);

                markers.push(marker);
            });
        }

        function renderListings() {
            const listingsDiv = document.getElementById('listings');
            const headerText = mode === 'seek' ? 'Available Food Nearby' : 'Your Donations';
            listingsDiv.innerHTML = '<h2 style="margin-bottom: 15px; color: #111827; font-size: 20px;">' + headerText + '</h2>';

            const displayListings = mode === 'donate' 
                ? foodListings.filter(l => l.donor === 'You')
                : foodListings;

            if (displayListings.length === 0 && mode === 'donate') {
                listingsDiv.innerHTML += '<p style="color: #9ca3af; text-align: center; padding: 20px;">No donations yet. Add your first donation!</p>';
                return;
            }

            displayListings.forEach(listing => {
                const div = document.createElement('div');
                div.className = 'listing';
                
                const h3 = document.createElement('h3');
                h3.textContent = listing.food;
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'listing-info';
                infoDiv.textContent = 'üìç ' + listing.location;
                
                div.appendChild(h3);
                div.appendChild(infoDiv);
                
                if (listing.details) {
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'listing-info';
                    detailsDiv.style.fontSize = '13px';
                    detailsDiv.textContent = listing.details;
                    div.appendChild(detailsDiv);
                }
                
                const metaDiv = document.createElement('div');
                metaDiv.className = 'listing-meta';
                metaDiv.innerHTML = '<span>‚è∞ ' + listing.time + '</span><span>üë§ ' + listing.donor + '</span>';
                div.appendChild(metaDiv);
                
                if (mode === 'seek') {
                    const btn = document.createElement('button');
                    btn.className = 'directionsBtn';
                    btn.textContent = 'Get Directions';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        getDirections(listing.lat, listing.lng);
                    };
                    div.appendChild(btn);
                }
                
                div.onclick = () => {
                    map.setView([listing.lat, listing.lng], 15);
                    const marker = markers.find(m => {
                        const pos = m.getLatLng();
                        return pos.lat === listing.lat && pos.lng === listing.lng;
                    });
                    if (marker) marker.openPopup();
                };
                
                listingsDiv.appendChild(div);
            });
        }

        function getDirections(destLat, destLng) {
            // Clear previous route
            if (routingControl) {
                map.removeLayer(routingControl);
            }

            // Draw a line for directions
            routingControl = L.polyline([
                userLocation,
                [destLat, destLng]
            ], {
                color: '#3b82f6',
                weight: 4,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);

            // Fit bounds to show entire route
            map.fitBounds(routingControl.getBounds(), { padding: [50, 50] });

            // Calculate distance
            const R = 6371; // Earth's radius in km
            const lat1 = userLocation[0] * Math.PI / 180;
            const lat2 = destLat * Math.PI / 180;
            const dLat = (destLat - userLocation[0]) * Math.PI / 180;
            const dLon = (destLng - userLocation[1]) * Math.PI / 180;

            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            alert(`Approximate distance: ${distance.toFixed(2)} km\n\nA straight line path is shown on the map. For turn-by-turn navigation, please use Google Maps or your preferred navigation app.`);
        }

        function showError(message) {
            const errorDiv = document.getElementById('formError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        async function geocodeAddress(address) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Delhi, India')}&limit=1`,
                    { headers: { 'User-Agent': 'AhaarHub/1.0' } }
                );
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon),
                        formattedAddress: data[0].display_name
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        document.getElementById('modeToggle').addEventListener('click', function() {
            mode = mode === 'seek' ? 'donate' : 'seek';
            this.textContent = mode === 'seek' ? 'üîç Seeking Food' : 'üçΩÔ∏è Donating Food';
            this.className = mode;
            
            document.getElementById('addButton').classList.toggle('hidden', mode === 'seek');
            document.getElementById('addForm').classList.add('hidden');
            renderListings();
        });

        document.getElementById('addButton').addEventListener('click', function() {
            document.getElementById('addForm').classList.remove('hidden');
        });

        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('addForm').classList.add('hidden');
            document.getElementById('foodInput').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('detailsInput').value = '';
            document.getElementById('formError').classList.add('hidden');
        });

        document.getElementById('postBtn').addEventListener('click', async function() {
            const food = document.getElementById('foodInput').value.trim();
            const location = document.getElementById('locationInput').value.trim();
            const details = document.getElementById('detailsInput').value.trim();
            const postBtn = document.getElementById('postBtn');

            if (!food || !location) {
                showError('Please fill in food and location fields');
                return;
            }

            postBtn.disabled = true;
            postBtn.textContent = 'Finding location...';

            const result = await geocodeAddress(location);

            postBtn.disabled = false;
            postBtn.textContent = 'Post';

            if (!result) {
                showError('Could not find the location. Please try a more specific address.');
                return;
            }

            const newListing = {
                id: Date.now(),
                food: food,
                location: location,
                lat: result.lat,
                lng: result.lng,
                time: 'Just now',
                donor: 'You',
                details: details
            };

            foodListings.unshift(newListing);
            renderMarkers();
            renderListings();

            document.getElementById('addForm').classList.add('hidden');
            document.getElementById('foodInput').value = '';
            document.getElementById('locationInput').value = '';
            document.getElementById('detailsInput').value = '';

            map.setView([newListing.lat, newListing.lng], 14);
        });

        // Initialize map when page loads
        window.onload = initMap;
    </script>
</body>

</html>
